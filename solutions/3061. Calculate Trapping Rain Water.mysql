WITH CTE AS(
    SELECT *,
    MAX(HEIGHT) OVER(ORDER BY ID) AS LEFT_HIGHEST_BAR,
    MAX(HEIGHT) OVER(ORDER BY ID DESC) AS RIGHT_HIGHEST_BAR
    FROM HEIGHTS
)
SELECT SUM(LEAST(LEFT_HIGHEST_BAR,RIGHT_HIGHEST_BAR)-HEIGHT) AS total_trapped_water 
FROM CTE
